# Техническая документация Gang Helper

## Архитектура

### Структура проекта

```
gang_helper/
├── gang_helper.lua           # Основной скрипт
├── config/
│   └── gang_config.json      # Конфигурационный файл
├── README.md                 # Документация пользователя
└── TECHNICAL.md             # Техническая документация
```

## Технический стек

### Основные библиотеки

1. **mimgui** - библиотека для создания GUI интерфейса
   - Используется для отрисовки меню
   - Обеспечивает интерактивность элементов

2. **encoding** - управление кодировками
   - Конвертация между CP1251 (используется SAMP) и UTF-8
   - Корректное отображение кириллицы

3. **jsoncfg** - работа с JSON конфигурацией
   - Сохранение и загрузка настроек
   - Поддержка структурированных данных

4. **samp.events** - перехват событий SAMP
   - Перехват команд игрока
   - Обработка событий сервера

### Основные компоненты

#### 1. Система конфигурации

```lua
config = {
    enabled: boolean,              # Включен ли хелпер
    delay_between_rp: number,      # Задержка между RP (мс)
    auto_rp_enabled: boolean,      # Авто-отыгровки
    log_actions: boolean,          # Логирование
    commands: {                    # Настройки команд
        [command_name]: {
            enabled: boolean,
            rp_before: string[],   # Отыгровки до
            rp_after: string[]     # Отыгровки после
        }
    }
}
```

#### 2. GUI система

- **Вкладка "Команды банды"**
  - Кнопки для быстрого выполнения команд
  - Поля ввода для параметров
  - Автоматический запуск отыгровок

- **Вкладка "Отыгровки"**
  - Раскрывающиеся секции для каждой команды
  - Поля для настройки до 5 отыгровок до команды
  - Поля для настройки до 5 отыгровок после команды
  - Кнопка сохранения

- **Вкладка "Настройки"**
  - Переключатели основных параметров
  - Слайдер задержки
  - Кнопка сброса настроек

#### 3. Система выполнения отыгровок

```lua
execute_rp_sequence(rp_list, callback)
```

Функция выполняет последовательность отыгровок:
1. Создаёт новый поток (lua_thread)
2. Проходит по списку отыгровок
3. Отправляет каждую отыгровку через sampSendChat
4. Делает паузу между отыгровками
5. Вызывает callback после завершения

#### 4. Система перехвата команд

```lua
function sampev.onSendCommand(command)
```

Перехватывает отправку команд игроком:
1. Проверяет, включен ли хелпер и авто-RP
2. Парсит команду и параметры
3. Проверяет, является ли команда банд-командой
4. Запускает execute_command_with_rp
5. Возвращает false, чтобы предотвратить отправку оригинальной команды

## Алгоритм работы

### Последовательность выполнения команды с RP

```
1. Игрок вводит команду (например, /capture)
   ↓
2. sampev.onSendCommand перехватывает команду
   ↓
3. Проверка: хелпер включен? → НЕТ → отправить команду как есть
   ↓ ДА
4. Проверка: авто-RP включен? → НЕТ → отправить команду как есть
   ↓ ДА
5. Проверка: команда в списке банд-команд? → НЕТ → отправить команду как есть
   ↓ ДА
6. Загрузить конфиг команды
   ↓
7. Выполнить rp_before (если есть)
   ↓
8. Выполнить саму команду
   ↓
9. Выполнить rp_after (если есть)
   ↓
10. Залогировать (если включено)
```

## Хранение данных

### Формат конфига (gang_config.json)

Конфигурация хранится в JSON формате в папке `config/`:

```json
{
  "enabled": true,
  "delay_between_rp": 1500,
  "auto_rp_enabled": true,
  "log_actions": true,
  "commands": {
    "capture": {
      "enabled": true,
      "rp_before": [
        "/me достал рацию из кармана",
        "/do Рация в руке.",
        "/me нажал на кнопку на рации"
      ],
      "rp_after": [
        "/me отпустил кнопку",
        "/me убрал рацию"
      ]
    }
  }
}
```

### Буферы ImGui

Для работы с ImGui используются специальные буферы:

```lua
input_buffers[cmd]           # char[256] - буферы для ввода параметров
rp_before_buffers[cmd][i]    # char[256] - буферы для RP до команды
rp_after_buffers[cmd][i]     # char[256] - буферы для RP после команды
```

## Оптимизация и производительность

### Потоки выполнения

- Отыгровки выполняются в отдельных lua_thread
- Флаг `is_executing_rp` предотвращает параллельное выполнение
- Использование wait() вместо блокирующих операций

### Память

- Буферы ImGui создаются один раз при инициализации
- Конфиг загружается при старте и сохраняется только при изменениях
- Минимальное использование глобальных переменных

## Расширяемость

### Добавление новой команды

1. Добавить команду в массив `gang_commands`:
```lua
{cmd = 'newcmd', name = 'Описание', params = '[параметры]'}
```

2. Добавить конфиг по умолчанию в `gang_config.json`

3. Скрипт автоматически создаст буферы и GUI элементы

### Кастомизация отыгровок

Отыгровки полностью настраиваются через GUI:
- Поддержка до 5 отыгровок до и после каждой команды
- Можно оставить поля пустыми для пропуска
- Изменения сохраняются в реальном времени

## Обработка ошибок

### Валидация данных

- Проверка существования конфига при загрузке
- Создание конфига по умолчанию если файл отсутствует
- Проверка наличия обязательных полей

### Логирование

```lua
function log(message)
    if config.log_actions then
        print('[Gang Helper] ' .. message)
    end
end
```

Все важные действия логируются при включенном параметре `log_actions`.

## Безопасность

- Не используются внешние запросы
- Все данные хранятся локально
- Нет передачи данных на сторонние серверы
- Конфиг в читаемом JSON формате

## Совместимость

### Требования к окружению

- MoonLoader 0.26+
- SAMP 0.3.7 или 0.3DL
- Arizona RP сервер
- Windows 7+

### Зависимости

Все используемые библиотеки входят в стандартную поставку MoonLoader:
- mimgui
- encoding
- jsoncfg (или альтернатива для работы с JSON)
- samp.events

## Известные ограничения

1. Максимум 5 отыгровок до и после каждой команды
2. Задержка между отыгровками: 500-5000 мс
3. Длина текста отыгровки: до 256 символов
4. Не поддерживается вложенное выполнение отыгровок

## Будущие улучшения

Потенциальные направления развития:
- Поддержка профилей отыгровок
- Импорт/экспорт конфигураций
- Рандомизация отыгровок из списка вариантов
- Условные отыгровки на основе контекста
- Интеграция с другими хелперами
- Система макросов

## Дебаг

### Проверка работы

1. Откройте moonloader.log
2. Найдите строки с `[Gang Helper]`
3. Проверьте выполнение команд и отыгровок

### Распространённые проблемы

**Меню не открывается**
- Проверьте, что скрипт загружен (moonloader.log)
- Убедитесь, что команда `/gang` написана правильно

**Отыгровки не выполняются**
- Проверьте, что хелпер включен в настройках
- Проверьте, что авто-RP включен
- Убедитесь, что отыгровки настроены для команды

**Конфиг не сохраняется**
- Проверьте права доступа к папке config
- Убедитесь, что путь к конфигу корректен
- Проверьте, что jsoncfg работает

## Контакты

При возникновении проблем или предложений по улучшению:
- Проверьте документацию
- Изучите логи
- Создайте issue с описанием проблемы
